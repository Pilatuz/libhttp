#include "http.h"

// logging tweaks
#undef  LOG_MODULE
#define LOG_MODULE "main"
#include "misc.h"

#include <alloca.h>
#include <string.h>
#include <stdio.h>

/**
 * @brief test for `http_parse_url` function.
 */
void test_parse_url(const char *url,
                    const char *expected_proto,
                    const char *expected_host,
                    const char *expected_path,
                    int expected_port)
{
    const char *actual_proto = 0;
    int actual_proto_len = 0;
    const char *actual_host = 0;
    int actual_host_len = 0;
    const char *actual_path = 0;
    int actual_path_len = 0;
    int actual_port = expected_port; // use default

    if (!!http_parse_url(url, &actual_proto, &actual_proto_len,
                         &actual_host, &actual_host_len, &actual_port,
                         &actual_path, &actual_path_len))
        printf("parse(%s) - FAILED\n", url);
    else if ((int)strlen(expected_proto) != actual_proto_len || 0 != strncmp(actual_proto, expected_proto, actual_proto_len))
        printf("parse(%s) proto %s != %.*s FAILED\n", url, expected_proto, actual_proto_len, actual_proto);
    else if ((int)strlen(expected_host) != actual_host_len || 0 != strncmp(actual_host, expected_host, actual_host_len))
        printf("parse(%s) host %s != %.*s FAILED\n", url, expected_host, actual_host_len, actual_host);
    else if ((int)strlen(expected_path) != actual_path_len || 0 != strncmp(actual_path, expected_path, actual_path_len))
        printf("parse(%s) path %s != %.*s FAILED\n", url, expected_path, actual_path_len, actual_path);
    else if (expected_port != actual_port)
        printf("parse(%s) port %d != %d FAILED\n", url, expected_port, actual_port);
    else
        printf("parse(%s) - OK\n", url);
}


/**
 * @brief test for `http_match_uri` function.
 */
void test_match_uri(const char *pattern, const char *uri, int expected)
{
    if (http_match_uri(pattern, uri) != expected)
        printf("match(%s, %s) != %d - FAILED\n", pattern, uri, expected);
    else
        printf("match(%s, %s) - OK\n", pattern, uri);
}


/**
 * @brief test for `http_find_crlf` function.
 */
void test_find_crlf(const char *line, int len, const char *expected)
{
    if (len < 0)
        len = strlen(line);
    const char *crlf = (const char*)http_find_crlf(line, len);

    // escape non-print symbols
    char *escaped_line = (char*)alloca(2*len);
    for (int i = 0; ; ++i, ++line)
    {
        if (*line == '\r')
        {
            escaped_line[i++] = '\\';
            escaped_line[i] = 'r';
        }
        else if (*line == '\n')
        {
            escaped_line[i++] = '\\';
            escaped_line[i] = 'n';
        }
        else
            escaped_line[i] = *line; // as is

        if (!*line)
            break;
    }

    if (expected)
    {
        if (crlf)
        {
            if (0 == strcmp(expected, crlf))
                printf("find_crlf(%s) - OK\n", escaped_line);
            else
                printf("find_crlf(%s) != %s - FAILED\n", escaped_line, expected);
        }
        else
            printf("find_crlf(%s) NOT FOUND - FAILED\n", escaped_line);
    }
    else
    {
        if (crlf)
            printf("find_crlf(%s) FALSE ALARM - FAILED\n", escaped_line);
        else
            printf("find_crlf(%s) - OK\n", escaped_line);
    }
}

/**
 * @brief Test for `http_parse_query` function.
 */
static void test_parse_query(const char *query, const char *name, const char *expected_value)
{
    while (0)
    {
        const char *name = 0;
        int name_len = 0;
        const char *val = 0;
        int val_len = 0;

        if (!!http_parse_query(&query, &name, &name_len, &val, &val_len))
            break;

        printf("%.*s=%.*s\n",
               name_len, name,
               val_len, val);
    }

    const char *value = 0;
    int value_len = 0;
    if (HTTP_ERR_SUCCESS == http_get_query_param(query, name, &value, &value_len))
    {
        if (expected_value)
        {
            const int expected_len = strlen(expected_value);
            if (expected_len == value_len && 0 == strncmp(expected_value, value, value_len))
            {
                printf("get_query_param(%s, %s) == \"%s\" - OK\n", query, name, expected_value);
            }
            else
            {
                printf("get_query_param(%s, %s) != \"%s\" - FAILED, found \"%.*s\" instead\n",
                       query, name, expected_value, value_len, value);
            }
        }
        else
            printf("get_query_param(%s, %s) - unexpected value found: \"%.*s\"\n",
                   query, name, value_len, value);
    }
    else
    {
        if (!expected_value)
        {
            printf("get_query_param(%s, %s) missing - OK\n", query, name);
        }
        else
        {
            printf("get_query_param(%s, %s) - FAILED, expected \"%s\"\n",
                   query, name, expected_value);
        }
    }
}

#include <wolfssl/wolfcrypt/rsa.h>
#include <wolfssl/wolfcrypt/ecc.h>
#include <wolfssl/ssl.h>

/**
 * @brief Application entry point.
 * @return Zero on success.
 */
int main(void)
{
    const int all = 0;

    if (1)
    {
        unsigned char root_priv_der[] = {
          0x30, 0x82, 0x04, 0xa4, 0x02, 0x01, 0x00, 0x02, 0x82, 0x01, 0x01, 0x00,
          0xc7, 0x7d, 0xba, 0x38, 0x03, 0x4b, 0x95, 0xc2, 0x18, 0xea, 0xca, 0x7a,
          0x97, 0xc2, 0x49, 0x66, 0xb5, 0x5e, 0x33, 0x9d, 0x44, 0xe8, 0x70, 0x5b,
          0xa6, 0xfb, 0x47, 0xf3, 0xb2, 0x4b, 0x1c, 0xc5, 0x1f, 0x39, 0xb7, 0xbb,
          0xe5, 0xab, 0x32, 0xe8, 0x9b, 0xce, 0x69, 0x0f, 0x3c, 0xda, 0xfb, 0x8e,
          0x74, 0xa7, 0x84, 0x3e, 0x73, 0x70, 0xb6, 0xf8, 0x45, 0x91, 0x1d, 0x22,
          0x7e, 0x68, 0x6a, 0x57, 0x07, 0x6e, 0x75, 0x99, 0x50, 0x4e, 0xea, 0x0d,
          0x41, 0x78, 0x7d, 0xac, 0x95, 0xfe, 0x9e, 0x0c, 0xa1, 0x37, 0x4c, 0xd8,
          0xdf, 0x94, 0x22, 0x10, 0x09, 0x87, 0x47, 0xb4, 0x9a, 0xad, 0x73, 0xba,
          0x2a, 0xee, 0xd1, 0xe9, 0x43, 0x68, 0x3d, 0x55, 0x48, 0x70, 0xcc, 0x9f,
          0xee, 0xfa, 0xcd, 0x31, 0xb6, 0xe7, 0xd7, 0x66, 0xdf, 0x94, 0x03, 0xa1,
          0x69, 0xb2, 0x6d, 0x9f, 0xdf, 0x0b, 0xac, 0xa3, 0x66, 0x23, 0xe2, 0xe0,
          0x12, 0xb7, 0xbc, 0x25, 0xfc, 0x6b, 0xce, 0x0f, 0x47, 0x43, 0x92, 0xef,
          0xda, 0x4b, 0xe1, 0xec, 0x57, 0x67, 0x67, 0x63, 0xc5, 0x9a, 0x9c, 0x99,
          0x2d, 0x55, 0x96, 0xcf, 0x18, 0xb2, 0x36, 0xea, 0x60, 0xf2, 0xe8, 0xb9,
          0x8d, 0xfa, 0xa4, 0x10, 0x55, 0x1b, 0x23, 0x58, 0xab, 0x09, 0xf5, 0x96,
          0x35, 0xb8, 0x0c, 0x57, 0x42, 0xd8, 0x6c, 0xe7, 0xfe, 0xe0, 0x1e, 0xdd,
          0xed, 0x9f, 0x67, 0xed, 0x19, 0x11, 0x2c, 0xa7, 0x31, 0xf8, 0xef, 0xda,
          0x05, 0x6e, 0x57, 0x6a, 0x56, 0xd5, 0x42, 0x7f, 0xd0, 0x83, 0xfd, 0x23,
          0xeb, 0xb2, 0x30, 0xbc, 0x97, 0x08, 0x12, 0x80, 0x84, 0x5c, 0x8f, 0x68,
          0xbf, 0x49, 0x13, 0xb1, 0x42, 0xd7, 0x8c, 0x0a, 0x22, 0x86, 0x02, 0xca,
          0xff, 0xa9, 0x4d, 0xbf, 0x5a, 0xe1, 0x65, 0xf9, 0xdc, 0xb9, 0x70, 0x0e,
          0xe8, 0x92, 0x44, 0x27, 0x02, 0x03, 0x01, 0x00, 0x01, 0x02, 0x82, 0x01,
          0x01, 0x00, 0x85, 0x18, 0xb8, 0x3e, 0x98, 0xcc, 0x3c, 0x2d, 0x94, 0xcc,
          0x49, 0xad, 0x43, 0x45, 0x48, 0x0d, 0xb3, 0xa2, 0x17, 0x13, 0xad, 0x9e,
          0xdb, 0x1f, 0xfb, 0x27, 0x99, 0xd8, 0xd8, 0xb2, 0xce, 0x8e, 0x22, 0x08,
          0x33, 0x32, 0xb4, 0xc7, 0xe5, 0x1e, 0x56, 0x9d, 0x7f, 0x70, 0xc0, 0x2c,
          0x66, 0x3b, 0xa4, 0x4f, 0x03, 0xa7, 0x5b, 0x03, 0xef, 0xbf, 0x73, 0x42,
          0x9f, 0x4a, 0x9d, 0x45, 0xf2, 0xf4, 0xff, 0xab, 0x4d, 0xe0, 0xad, 0x39,
          0x09, 0x65, 0x30, 0xb2, 0x40, 0x3e, 0xfe, 0x90, 0x33, 0x48, 0xbf, 0xe3,
          0x12, 0x6d, 0x7b, 0xb5, 0xec, 0x88, 0x00, 0xa3, 0x76, 0x4e, 0xe4, 0x08,
          0x27, 0xb7, 0x24, 0xdf, 0xd3, 0xc3, 0x2a, 0xcb, 0x08, 0x68, 0xb6, 0xfd,
          0x33, 0x38, 0xdd, 0x8c, 0x0d, 0x8d, 0x46, 0xb8, 0x25, 0xf9, 0xa7, 0xdf,
          0xac, 0x10, 0x6c, 0x61, 0xb4, 0x4c, 0x3e, 0xd7, 0x1e, 0x25, 0x74, 0xf1,
          0xd2, 0xc8, 0x26, 0x83, 0x16, 0x0d, 0xd3, 0xf5, 0x2d, 0xdd, 0x8a, 0x1b,
          0x3e, 0xcc, 0xb9, 0xec, 0x7e, 0x21, 0xf7, 0xb5, 0xa9, 0x51, 0x42, 0x87,
          0x4a, 0xc3, 0x44, 0x57, 0x33, 0x6e, 0x66, 0x01, 0xb1, 0x43, 0x1d, 0x2a,
          0xe1, 0x58, 0x11, 0x4e, 0xaa, 0xd8, 0xda, 0x59, 0x27, 0xd1, 0x6a, 0x54,
          0xed, 0x03, 0x0b, 0x19, 0x7e, 0xbb, 0x6c, 0x02, 0x5d, 0x26, 0xf1, 0x0f,
          0x9d, 0x9b, 0x07, 0xb0, 0xbc, 0xf5, 0xe5, 0x75, 0xbf, 0xaa, 0xd3, 0x38,
          0x25, 0x2e, 0xbc, 0xfb, 0xb0, 0xf8, 0x10, 0xed, 0x9f, 0x4c, 0x47, 0xeb,
          0x8d, 0x8b, 0x82, 0xd6, 0x58, 0x13, 0x84, 0x5d, 0x84, 0xac, 0x4c, 0x6a,
          0xf0, 0x6d, 0xf3, 0x58, 0x68, 0x50, 0x25, 0xea, 0xaf, 0xe5, 0xbf, 0x1a,
          0xbe, 0xa8, 0xc0, 0x63, 0xe1, 0x15, 0xba, 0x5c, 0xd2, 0x58, 0x45, 0xb0,
          0xd2, 0xc2, 0xbd, 0x24, 0x53, 0x49, 0x02, 0x81, 0x81, 0x00, 0xe5, 0x4a,
          0x2e, 0x1e, 0xc1, 0xc5, 0xb8, 0xf0, 0x21, 0x13, 0x05, 0x7e, 0x63, 0x21,
          0x9b, 0xcc, 0xb8, 0x89, 0xf6, 0x21, 0x50, 0xca, 0xdb, 0x8e, 0x26, 0x6c,
          0x9e, 0x64, 0xb3, 0x79, 0xcf, 0x16, 0xe1, 0x6c, 0x75, 0x46, 0xf4, 0x91,
          0xf4, 0x81, 0x28, 0x52, 0x5e, 0x9e, 0x60, 0x9a, 0xcc, 0x02, 0xfa, 0xeb,
          0x5f, 0x1f, 0x92, 0x13, 0xab, 0x13, 0xb5, 0x95, 0xea, 0x14, 0x3d, 0x88,
          0x36, 0x1b, 0x69, 0xaa, 0x18, 0x50, 0xdb, 0xce, 0x93, 0x51, 0x8a, 0xed,
          0x1c, 0x4e, 0x88, 0xaf, 0x0d, 0x36, 0xcd, 0xe5, 0xe6, 0x0f, 0x0f, 0x69,
          0x59, 0xe8, 0xd6, 0x42, 0x4e, 0x5f, 0x17, 0x10, 0x30, 0x24, 0x37, 0x6a,
          0x56, 0x39, 0xda, 0x8a, 0x35, 0x8c, 0x18, 0x9b, 0xac, 0xde, 0x4a, 0xa4,
          0x82, 0xa0, 0x79, 0x2d, 0xab, 0x8c, 0xff, 0x9d, 0x95, 0x1e, 0x97, 0x45,
          0x16, 0xab, 0xdf, 0xe7, 0xe6, 0x45, 0x02, 0x81, 0x81, 0x00, 0xde, 0xba,
          0xe6, 0x5c, 0xe0, 0x35, 0xd6, 0x37, 0x89, 0x7d, 0xbd, 0x65, 0x8f, 0x64,
          0x55, 0xed, 0x1b, 0x0a, 0x71, 0x9e, 0x69, 0xd2, 0xa4, 0xe9, 0x31, 0xf9,
          0x22, 0x66, 0xdb, 0x11, 0x85, 0xc0, 0x16, 0x88, 0x34, 0xde, 0x08, 0x71,
          0x91, 0x1c, 0x69, 0xcf, 0x55, 0x5a, 0xf9, 0x54, 0xdb, 0x55, 0x46, 0xfa,
          0x3a, 0x43, 0x3b, 0xd0, 0xf5, 0x8c, 0x58, 0x80, 0xf2, 0x06, 0x6d, 0x54,
          0x79, 0x73, 0x70, 0x6c, 0x16, 0xbd, 0x3a, 0x7e, 0x30, 0x27, 0xf3, 0x69,
          0x02, 0x32, 0x46, 0xf1, 0xf8, 0x13, 0xeb, 0x73, 0x02, 0x9d, 0xf8, 0x2e,
          0x4e, 0x93, 0x84, 0x92, 0xbe, 0x7b, 0x6d, 0x49, 0x16, 0xf7, 0x7e, 0x16,
          0xfb, 0x04, 0x90, 0x99, 0x42, 0x39, 0x32, 0xdb, 0xe2, 0x42, 0x92, 0x4e,
          0x42, 0xa4, 0x28, 0x70, 0x9b, 0x33, 0xda, 0x4a, 0xef, 0xdc, 0xe4, 0x93,
          0x32, 0x01, 0x1d, 0x02, 0xad, 0x7b, 0x02, 0x81, 0x81, 0x00, 0xdc, 0x2d,
          0xe8, 0xad, 0xe6, 0x5b, 0x8d, 0x25, 0x22, 0x4d, 0x96, 0xc7, 0xf0, 0x3f,
          0xb4, 0xd1, 0xd9, 0x1f, 0xba, 0x37, 0xf1, 0xd2, 0x6b, 0x15, 0x4c, 0xf6,
          0x9e, 0xff, 0x8a, 0x8d, 0x5c, 0xfc, 0xd6, 0xc9, 0x84, 0xb0, 0xf7, 0x68,
          0x35, 0x07, 0xd6, 0x05, 0x8b, 0x10, 0xc1, 0x29, 0xc4, 0xe0, 0xd3, 0xbd,
          0x34, 0x22, 0x27, 0xef, 0x35, 0x27, 0xff, 0x06, 0x8f, 0xba, 0x91, 0xff,
          0xfc, 0x1d, 0x44, 0xd1, 0x6e, 0xfa, 0x2e, 0xa9, 0x67, 0x34, 0x35, 0x99,
          0x4d, 0xc6, 0x68, 0x60, 0xd8, 0xea, 0x98, 0xbb, 0xbc, 0xb9, 0x17, 0x8e,
          0x8e, 0x25, 0x15, 0xa2, 0xa4, 0x89, 0x91, 0xa7, 0x1c, 0xe3, 0x9a, 0x47,
          0x45, 0xb7, 0xd6, 0x91, 0x43, 0xac, 0x5d, 0x71, 0x18, 0x86, 0x79, 0xdd,
          0x12, 0x07, 0x31, 0x76, 0x56, 0xb7, 0x56, 0x3b, 0x27, 0x98, 0x31, 0xa0,
          0xc9, 0x8d, 0x90, 0xbc, 0xaa, 0x95, 0x02, 0x81, 0x80, 0x34, 0xa9, 0x0d,
          0xe4, 0x31, 0xa2, 0xa8, 0xf6, 0x52, 0x8c, 0xa7, 0x26, 0x07, 0x04, 0x1b,
          0x08, 0xc7, 0x56, 0xed, 0xcc, 0x1d, 0x8b, 0x0f, 0x30, 0x8f, 0x7f, 0x2e,
          0xf2, 0x10, 0xa3, 0x90, 0xf2, 0xfc, 0xa0, 0xd1, 0x97, 0x19, 0x79, 0xf8,
          0x6c, 0x36, 0x5c, 0x2d, 0xfb, 0x27, 0x6e, 0x37, 0xb9, 0x6e, 0xe1, 0xa4,
          0xba, 0xd6, 0xbe, 0xad, 0xff, 0xb3, 0xc1, 0x30, 0xf7, 0xf2, 0x0b, 0x81,
          0xf7, 0x98, 0x42, 0x06, 0x12, 0x51, 0x6d, 0x1a, 0x67, 0xa7, 0xb6, 0x51,
          0x2d, 0x9f, 0xf6, 0x7f, 0xc7, 0xfd, 0xe8, 0x20, 0x5b, 0x47, 0x1d, 0x73,
          0xb8, 0x8f, 0x24, 0xbe, 0xe2, 0xa1, 0xd1, 0x21, 0x1b, 0xfc, 0xf4, 0xe3,
          0xfe, 0x8d, 0x4d, 0x9f, 0x09, 0xb5, 0x0b, 0xa5, 0xf0, 0x45, 0x75, 0x39,
          0x6e, 0x64, 0x9d, 0x53, 0x24, 0xac, 0x5d, 0x01, 0x5f, 0x41, 0xaf, 0xc7,
          0xa7, 0xd9, 0xbb, 0x13, 0x57, 0x02, 0x81, 0x80, 0x3b, 0x1c, 0x0d, 0xc4,
          0xc4, 0xd2, 0x6c, 0x3d, 0xd9, 0x75, 0x74, 0x55, 0xb7, 0xfd, 0xec, 0xe3,
          0x3c, 0x8e, 0x62, 0xd3, 0xfe, 0x11, 0x0f, 0x6b, 0x4d, 0x6f, 0x71, 0x37,
          0xa5, 0x2a, 0x8d, 0x16, 0x0b, 0xd1, 0xf3, 0xb5, 0x0b, 0x13, 0x5a, 0x0f,
          0x9d, 0xef, 0x65, 0xf9, 0x6f, 0x9d, 0x4f, 0x80, 0x39, 0x87, 0x84, 0x33,
          0xd2, 0x83, 0xd0, 0xe4, 0xf8, 0xcb, 0xef, 0x3d, 0xe6, 0x12, 0x3c, 0xed,
          0x15, 0xec, 0x3c, 0x74, 0x86, 0x96, 0x63, 0x03, 0x1a, 0x0b, 0xaf, 0xc6,
          0x04, 0x35, 0xe5, 0x26, 0xf0, 0x98, 0xc1, 0x44, 0xb8, 0x5f, 0xda, 0x22,
          0xec, 0x59, 0xac, 0x64, 0xe8, 0x65, 0xfa, 0x3c, 0x9d, 0x3e, 0x7f, 0xcc,
          0x74, 0x28, 0x20, 0xb1, 0xa7, 0x03, 0xa2, 0x2c, 0xf0, 0x19, 0x4b, 0xfe,
          0xa0, 0x4c, 0x8c, 0xb7, 0xbc, 0x22, 0xd9, 0x2f, 0x42, 0xaf, 0xed, 0x87,
          0x73, 0xf4, 0x8a, 0x48
        };
        unsigned int root_priv_der_len = 1192;

        unsigned char root_cert_der[] = {
          0x30, 0x82, 0x04, 0x04, 0x30, 0x82, 0x02, 0xec, 0xa0, 0x03, 0x02, 0x01,
          0x02, 0x02, 0x09, 0x00, 0xee, 0x7a, 0xf8, 0x20, 0x3a, 0xb1, 0x69, 0x80,
          0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01,
          0x0b, 0x05, 0x00, 0x30, 0x81, 0x95, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03,
          0x55, 0x04, 0x06, 0x13, 0x02, 0x43, 0x48, 0x31, 0x12, 0x30, 0x10, 0x06,
          0x03, 0x55, 0x04, 0x08, 0x0c, 0x09, 0x53, 0x74, 0x2e, 0x47, 0x61, 0x6c,
          0x6c, 0x65, 0x6e, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x07,
          0x0c, 0x06, 0x46, 0x6c, 0x61, 0x77, 0x69, 0x6c, 0x31, 0x1e, 0x30, 0x1c,
          0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x15, 0x42, 0x55, 0x43, 0x48, 0x49,
          0x20, 0x4c, 0x61, 0x62, 0x6f, 0x72, 0x74, 0x65, 0x63, 0x68, 0x6e, 0x69,
          0x6b, 0x20, 0x41, 0x47, 0x31, 0x1e, 0x30, 0x1c, 0x06, 0x03, 0x55, 0x04,
          0x03, 0x0c, 0x15, 0x42, 0x75, 0x63, 0x68, 0x69, 0x4f, 0x70, 0x65, 0x6e,
          0x49, 0x6e, 0x74, 0x65, 0x72, 0x66, 0x61, 0x63, 0x65, 0x20, 0x43, 0x41,
          0x31, 0x21, 0x30, 0x1f, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
          0x01, 0x09, 0x01, 0x16, 0x12, 0x73, 0x6f, 0x66, 0x74, 0x77, 0x61, 0x72,
          0x65, 0x40, 0x62, 0x75, 0x63, 0x68, 0x69, 0x2e, 0x63, 0x6f, 0x6d, 0x30,
          0x20, 0x17, 0x0d, 0x31, 0x38, 0x30, 0x37, 0x33, 0x30, 0x31, 0x32, 0x32,
          0x33, 0x34, 0x31, 0x5a, 0x18, 0x0f, 0x32, 0x30, 0x35, 0x38, 0x30, 0x37,
          0x33, 0x30, 0x31, 0x32, 0x32, 0x33, 0x34, 0x31, 0x5a, 0x30, 0x81, 0x95,
          0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x43,
          0x48, 0x31, 0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x09,
          0x53, 0x74, 0x2e, 0x47, 0x61, 0x6c, 0x6c, 0x65, 0x6e, 0x31, 0x0f, 0x30,
          0x0d, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x06, 0x46, 0x6c, 0x61, 0x77,
          0x69, 0x6c, 0x31, 0x1e, 0x30, 0x1c, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c,
          0x15, 0x42, 0x55, 0x43, 0x48, 0x49, 0x20, 0x4c, 0x61, 0x62, 0x6f, 0x72,
          0x74, 0x65, 0x63, 0x68, 0x6e, 0x69, 0x6b, 0x20, 0x41, 0x47, 0x31, 0x1e,
          0x30, 0x1c, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c, 0x15, 0x42, 0x75, 0x63,
          0x68, 0x69, 0x4f, 0x70, 0x65, 0x6e, 0x49, 0x6e, 0x74, 0x65, 0x72, 0x66,
          0x61, 0x63, 0x65, 0x20, 0x43, 0x41, 0x31, 0x21, 0x30, 0x1f, 0x06, 0x09,
          0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x09, 0x01, 0x16, 0x12, 0x73,
          0x6f, 0x66, 0x74, 0x77, 0x61, 0x72, 0x65, 0x40, 0x62, 0x75, 0x63, 0x68,
          0x69, 0x2e, 0x63, 0x6f, 0x6d, 0x30, 0x82, 0x01, 0x22, 0x30, 0x0d, 0x06,
          0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00,
          0x03, 0x82, 0x01, 0x0f, 0x00, 0x30, 0x82, 0x01, 0x0a, 0x02, 0x82, 0x01,
          0x01, 0x00, 0xc7, 0x7d, 0xba, 0x38, 0x03, 0x4b, 0x95, 0xc2, 0x18, 0xea,
          0xca, 0x7a, 0x97, 0xc2, 0x49, 0x66, 0xb5, 0x5e, 0x33, 0x9d, 0x44, 0xe8,
          0x70, 0x5b, 0xa6, 0xfb, 0x47, 0xf3, 0xb2, 0x4b, 0x1c, 0xc5, 0x1f, 0x39,
          0xb7, 0xbb, 0xe5, 0xab, 0x32, 0xe8, 0x9b, 0xce, 0x69, 0x0f, 0x3c, 0xda,
          0xfb, 0x8e, 0x74, 0xa7, 0x84, 0x3e, 0x73, 0x70, 0xb6, 0xf8, 0x45, 0x91,
          0x1d, 0x22, 0x7e, 0x68, 0x6a, 0x57, 0x07, 0x6e, 0x75, 0x99, 0x50, 0x4e,
          0xea, 0x0d, 0x41, 0x78, 0x7d, 0xac, 0x95, 0xfe, 0x9e, 0x0c, 0xa1, 0x37,
          0x4c, 0xd8, 0xdf, 0x94, 0x22, 0x10, 0x09, 0x87, 0x47, 0xb4, 0x9a, 0xad,
          0x73, 0xba, 0x2a, 0xee, 0xd1, 0xe9, 0x43, 0x68, 0x3d, 0x55, 0x48, 0x70,
          0xcc, 0x9f, 0xee, 0xfa, 0xcd, 0x31, 0xb6, 0xe7, 0xd7, 0x66, 0xdf, 0x94,
          0x03, 0xa1, 0x69, 0xb2, 0x6d, 0x9f, 0xdf, 0x0b, 0xac, 0xa3, 0x66, 0x23,
          0xe2, 0xe0, 0x12, 0xb7, 0xbc, 0x25, 0xfc, 0x6b, 0xce, 0x0f, 0x47, 0x43,
          0x92, 0xef, 0xda, 0x4b, 0xe1, 0xec, 0x57, 0x67, 0x67, 0x63, 0xc5, 0x9a,
          0x9c, 0x99, 0x2d, 0x55, 0x96, 0xcf, 0x18, 0xb2, 0x36, 0xea, 0x60, 0xf2,
          0xe8, 0xb9, 0x8d, 0xfa, 0xa4, 0x10, 0x55, 0x1b, 0x23, 0x58, 0xab, 0x09,
          0xf5, 0x96, 0x35, 0xb8, 0x0c, 0x57, 0x42, 0xd8, 0x6c, 0xe7, 0xfe, 0xe0,
          0x1e, 0xdd, 0xed, 0x9f, 0x67, 0xed, 0x19, 0x11, 0x2c, 0xa7, 0x31, 0xf8,
          0xef, 0xda, 0x05, 0x6e, 0x57, 0x6a, 0x56, 0xd5, 0x42, 0x7f, 0xd0, 0x83,
          0xfd, 0x23, 0xeb, 0xb2, 0x30, 0xbc, 0x97, 0x08, 0x12, 0x80, 0x84, 0x5c,
          0x8f, 0x68, 0xbf, 0x49, 0x13, 0xb1, 0x42, 0xd7, 0x8c, 0x0a, 0x22, 0x86,
          0x02, 0xca, 0xff, 0xa9, 0x4d, 0xbf, 0x5a, 0xe1, 0x65, 0xf9, 0xdc, 0xb9,
          0x70, 0x0e, 0xe8, 0x92, 0x44, 0x27, 0x02, 0x03, 0x01, 0x00, 0x01, 0xa3,
          0x53, 0x30, 0x51, 0x30, 0x1d, 0x06, 0x03, 0x55, 0x1d, 0x0e, 0x04, 0x16,
          0x04, 0x14, 0x45, 0x1e, 0xa7, 0x4c, 0x42, 0xe8, 0x37, 0x9e, 0x67, 0x72,
          0x27, 0xa0, 0x1b, 0xae, 0x1c, 0xa0, 0x50, 0x2e, 0xf1, 0x90, 0x30, 0x1f,
          0x06, 0x03, 0x55, 0x1d, 0x23, 0x04, 0x18, 0x30, 0x16, 0x80, 0x14, 0x45,
          0x1e, 0xa7, 0x4c, 0x42, 0xe8, 0x37, 0x9e, 0x67, 0x72, 0x27, 0xa0, 0x1b,
          0xae, 0x1c, 0xa0, 0x50, 0x2e, 0xf1, 0x90, 0x30, 0x0f, 0x06, 0x03, 0x55,
          0x1d, 0x13, 0x01, 0x01, 0xff, 0x04, 0x05, 0x30, 0x03, 0x01, 0x01, 0xff,
          0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01,
          0x0b, 0x05, 0x00, 0x03, 0x82, 0x01, 0x01, 0x00, 0x73, 0x0c, 0x2c, 0x7f,
          0xc9, 0xce, 0x67, 0xfb, 0x7f, 0x23, 0xf1, 0x4e, 0xe0, 0x8e, 0xe9, 0x89,
          0x99, 0xdc, 0x59, 0x95, 0xac, 0xfa, 0x3d, 0xaf, 0x5a, 0x12, 0xa9, 0x6c,
          0x47, 0x6e, 0xc1, 0x3e, 0xcc, 0xb9, 0x76, 0x2e, 0x03, 0xe3, 0x55, 0x8e,
          0x32, 0xc6, 0x75, 0xd7, 0x24, 0x6b, 0xd4, 0x6c, 0x6b, 0x41, 0x20, 0xb1,
          0xfe, 0x38, 0x8e, 0x5d, 0x15, 0x4f, 0x55, 0x77, 0x5f, 0x48, 0x0d, 0xa4,
          0x7e, 0xb5, 0x73, 0x55, 0xac, 0xb0, 0xef, 0xb1, 0xe7, 0x5b, 0x19, 0x98,
          0x17, 0x5c, 0x30, 0xf0, 0xbc, 0x2d, 0xfd, 0xb6, 0x63, 0x94, 0x8e, 0x61,
          0x50, 0xc9, 0xf0, 0xcc, 0x71, 0x13, 0x69, 0xa3, 0x25, 0x94, 0xd2, 0x10,
          0x3f, 0x73, 0x73, 0x4c, 0x67, 0x13, 0xb5, 0x7e, 0x50, 0x96, 0xfc, 0x44,
          0xc5, 0xdb, 0x2e, 0x9b, 0x83, 0x99, 0xf2, 0x0a, 0x48, 0xbe, 0x35, 0x1f,
          0x5b, 0xdc, 0xe9, 0x41, 0xd1, 0xe5, 0xb3, 0x48, 0x79, 0x8b, 0x17, 0xce,
          0x9d, 0x38, 0x0e, 0x29, 0xcf, 0x22, 0xb1, 0x35, 0x45, 0x24, 0x16, 0x82,
          0x34, 0x99, 0x1a, 0x43, 0xbd, 0xbc, 0x7b, 0xdb, 0xee, 0x4b, 0x25, 0xe7,
          0xe8, 0x2e, 0x16, 0x2b, 0x89, 0xc8, 0xc9, 0x5a, 0x3d, 0x50, 0x56, 0xb8,
          0x30, 0x61, 0xc1, 0x8e, 0xaf, 0x6b, 0x2a, 0x3e, 0x42, 0x4d, 0xca, 0x8a,
          0x07, 0x4d, 0xb8, 0xd6, 0x3f, 0x15, 0x4f, 0x8f, 0xed, 0x2f, 0x7c, 0xa6,
          0xc5, 0x09, 0x4b, 0x97, 0x31, 0xba, 0x0b, 0x0d, 0xbc, 0x7b, 0xb5, 0x00,
          0x23, 0x2f, 0x9a, 0x6d, 0xdd, 0xaa, 0xe3, 0x88, 0xde, 0x89, 0x14, 0x33,
          0x3b, 0xcd, 0x27, 0x7c, 0x40, 0x7d, 0xab, 0x09, 0x98, 0xd6, 0x9e, 0x98,
          0x2d, 0xb3, 0x23, 0xe2, 0xff, 0xe3, 0xb5, 0xcc, 0x23, 0xfe, 0x6c, 0xb7,
          0x9e, 0xfe, 0xf3, 0x66, 0x23, 0x21, 0xb5, 0x4c, 0x12, 0x29, 0x8b, 0x54
        };
        unsigned int root_cert_der_len = 1032;

        FILE *f = fopen("root_cert.der", "w");
        fwrite(root_cert_der, 1, root_cert_der_len, f);
        fclose(f);

        f = fopen("root_key.der", "w");
        fwrite(root_priv_der, 1, root_priv_der_len, f);
        fclose(f);

        return 0; // OK
    }

#define USE_ECC_KEYS 1
    if (0) // cert
    {
        int RestKeySize = 0, RestCertSize = 0;
        int RestKeyUnsaved = 0, RestCertUnsaved = 0;
        uint8_t RestKey[4096];
        uint8_t RestCert[4096];

        //uint32_t iPAdrDev = 0xaabbccdd;

        WC_RNG my_rng;
     #if defined(USE_ECC_KEYS) && USE_ECC_KEYS
        ecc_key my_key;
     #else
        RsaKey my_key;
     #endif // USE_ECC_KEYS
        Cert my_cert;

        if (1) // need to generate new one private key
        {
           INFO("Generating new one REST service private key...");

           wc_InitRng(&my_rng);
     #if defined(USE_ECC_KEYS) && USE_ECC_KEYS
           wc_ecc_init(&my_key);
           int ret = wc_ecc_make_key_ex(&my_rng, /*keysize_octets=*/256/8, &my_key, ECC_SECP256R1);
     #else
           wc_InitRsaKey(&my_key, 0);
           int ret = wc_MakeRsaKey(&my_key, 2048, 0x10001, &my_rng);
     #endif // USE_ECC_KEYS
           if (ret != 0)
           {
              ERROR("failed to generate private key: %d\n", ret);
              return -1;
           }

     #if defined(USE_ECC_KEYS) && USE_ECC_KEYS
           RestKeySize = wc_EccKeyToDer(&my_key, (byte*)RestKey, sizeof(RestKey));
     #else
           RestKeySize = wc_RsaKeyToDer(&my_key, (byte*)RestKey, sizeof(RestKey));
     #endif // USE_ECC_KEYS
           if (RestKeySize < 0)
           {
              ERROR("failed to convert private key to DER: %d\n", RestKeySize);
              return -1;
           }

           INFO("New REST service private key of %d bytes generated", RestKeySize);
           RestKeyUnsaved = 1; // need to write it back to EEPROM
        }


         if (1) // still no certificate, need to generate new one
         {
            INFO("Generating new one REST service certificate...");

            wc_InitCert(&my_cert);
            my_cert.sigType = CTC_SHA256wRSA; // CTC_SHA256wECDSA
            strncpy(my_cert.subject.country, "CH", CTC_NAME_SIZE);
            strncpy(my_cert.subject.locality, "St.Gallen", CTC_NAME_SIZE);
            strncpy(my_cert.subject.org, "BUCHI Labortechnik AG", CTC_NAME_SIZE);
            strncpy(my_cert.subject.unit, "I-300", CTC_NAME_SIZE);
            //strncpy(my_cert.subject.commonName, "i300.buchi.com", CTC_NAME_SIZE);
            snprintf(my_cert.subject.commonName, CTC_NAME_SIZE, "%d.%d.%d.%d", 0xaa,0xbb,0xcc,0xdd);
            strncpy(my_cert.subject.email, "software@buchi.com", CTC_NAME_SIZE);
            my_cert.daysValid = 10*365; // 10 years

            if (1) // serial number (MAC+time)
            {
               uint8_t *sbuf = my_cert.serial;
               //GetMacAddress(sbuf); sbuf += 6;
               *++sbuf = 0x11;
               *++sbuf = 0x22;
               *++sbuf = 0x33;
               *++sbuf = 0x44;
               *++sbuf = 0x55;
               *++sbuf = 0x66;
               uint32_t now = XTIME(0); // use time() from WolfSSL
               //sprintf((char*)sbuf, "%08x", now); sbuf += 8;
               memcpy(sbuf, &now, 4); sbuf += 4;
               my_cert.serialSz = (sbuf - my_cert.serial);
            }

     #if 1 // use common root certificate
     unsigned char root_priv_der[] = {
       0x30, 0x82, 0x04, 0xa4, 0x02, 0x01, 0x00, 0x02, 0x82, 0x01, 0x01, 0x00,
       0xc7, 0x7d, 0xba, 0x38, 0x03, 0x4b, 0x95, 0xc2, 0x18, 0xea, 0xca, 0x7a,
       0x97, 0xc2, 0x49, 0x66, 0xb5, 0x5e, 0x33, 0x9d, 0x44, 0xe8, 0x70, 0x5b,
       0xa6, 0xfb, 0x47, 0xf3, 0xb2, 0x4b, 0x1c, 0xc5, 0x1f, 0x39, 0xb7, 0xbb,
       0xe5, 0xab, 0x32, 0xe8, 0x9b, 0xce, 0x69, 0x0f, 0x3c, 0xda, 0xfb, 0x8e,
       0x74, 0xa7, 0x84, 0x3e, 0x73, 0x70, 0xb6, 0xf8, 0x45, 0x91, 0x1d, 0x22,
       0x7e, 0x68, 0x6a, 0x57, 0x07, 0x6e, 0x75, 0x99, 0x50, 0x4e, 0xea, 0x0d,
       0x41, 0x78, 0x7d, 0xac, 0x95, 0xfe, 0x9e, 0x0c, 0xa1, 0x37, 0x4c, 0xd8,
       0xdf, 0x94, 0x22, 0x10, 0x09, 0x87, 0x47, 0xb4, 0x9a, 0xad, 0x73, 0xba,
       0x2a, 0xee, 0xd1, 0xe9, 0x43, 0x68, 0x3d, 0x55, 0x48, 0x70, 0xcc, 0x9f,
       0xee, 0xfa, 0xcd, 0x31, 0xb6, 0xe7, 0xd7, 0x66, 0xdf, 0x94, 0x03, 0xa1,
       0x69, 0xb2, 0x6d, 0x9f, 0xdf, 0x0b, 0xac, 0xa3, 0x66, 0x23, 0xe2, 0xe0,
       0x12, 0xb7, 0xbc, 0x25, 0xfc, 0x6b, 0xce, 0x0f, 0x47, 0x43, 0x92, 0xef,
       0xda, 0x4b, 0xe1, 0xec, 0x57, 0x67, 0x67, 0x63, 0xc5, 0x9a, 0x9c, 0x99,
       0x2d, 0x55, 0x96, 0xcf, 0x18, 0xb2, 0x36, 0xea, 0x60, 0xf2, 0xe8, 0xb9,
       0x8d, 0xfa, 0xa4, 0x10, 0x55, 0x1b, 0x23, 0x58, 0xab, 0x09, 0xf5, 0x96,
       0x35, 0xb8, 0x0c, 0x57, 0x42, 0xd8, 0x6c, 0xe7, 0xfe, 0xe0, 0x1e, 0xdd,
       0xed, 0x9f, 0x67, 0xed, 0x19, 0x11, 0x2c, 0xa7, 0x31, 0xf8, 0xef, 0xda,
       0x05, 0x6e, 0x57, 0x6a, 0x56, 0xd5, 0x42, 0x7f, 0xd0, 0x83, 0xfd, 0x23,
       0xeb, 0xb2, 0x30, 0xbc, 0x97, 0x08, 0x12, 0x80, 0x84, 0x5c, 0x8f, 0x68,
       0xbf, 0x49, 0x13, 0xb1, 0x42, 0xd7, 0x8c, 0x0a, 0x22, 0x86, 0x02, 0xca,
       0xff, 0xa9, 0x4d, 0xbf, 0x5a, 0xe1, 0x65, 0xf9, 0xdc, 0xb9, 0x70, 0x0e,
       0xe8, 0x92, 0x44, 0x27, 0x02, 0x03, 0x01, 0x00, 0x01, 0x02, 0x82, 0x01,
       0x01, 0x00, 0x85, 0x18, 0xb8, 0x3e, 0x98, 0xcc, 0x3c, 0x2d, 0x94, 0xcc,
       0x49, 0xad, 0x43, 0x45, 0x48, 0x0d, 0xb3, 0xa2, 0x17, 0x13, 0xad, 0x9e,
       0xdb, 0x1f, 0xfb, 0x27, 0x99, 0xd8, 0xd8, 0xb2, 0xce, 0x8e, 0x22, 0x08,
       0x33, 0x32, 0xb4, 0xc7, 0xe5, 0x1e, 0x56, 0x9d, 0x7f, 0x70, 0xc0, 0x2c,
       0x66, 0x3b, 0xa4, 0x4f, 0x03, 0xa7, 0x5b, 0x03, 0xef, 0xbf, 0x73, 0x42,
       0x9f, 0x4a, 0x9d, 0x45, 0xf2, 0xf4, 0xff, 0xab, 0x4d, 0xe0, 0xad, 0x39,
       0x09, 0x65, 0x30, 0xb2, 0x40, 0x3e, 0xfe, 0x90, 0x33, 0x48, 0xbf, 0xe3,
       0x12, 0x6d, 0x7b, 0xb5, 0xec, 0x88, 0x00, 0xa3, 0x76, 0x4e, 0xe4, 0x08,
       0x27, 0xb7, 0x24, 0xdf, 0xd3, 0xc3, 0x2a, 0xcb, 0x08, 0x68, 0xb6, 0xfd,
       0x33, 0x38, 0xdd, 0x8c, 0x0d, 0x8d, 0x46, 0xb8, 0x25, 0xf9, 0xa7, 0xdf,
       0xac, 0x10, 0x6c, 0x61, 0xb4, 0x4c, 0x3e, 0xd7, 0x1e, 0x25, 0x74, 0xf1,
       0xd2, 0xc8, 0x26, 0x83, 0x16, 0x0d, 0xd3, 0xf5, 0x2d, 0xdd, 0x8a, 0x1b,
       0x3e, 0xcc, 0xb9, 0xec, 0x7e, 0x21, 0xf7, 0xb5, 0xa9, 0x51, 0x42, 0x87,
       0x4a, 0xc3, 0x44, 0x57, 0x33, 0x6e, 0x66, 0x01, 0xb1, 0x43, 0x1d, 0x2a,
       0xe1, 0x58, 0x11, 0x4e, 0xaa, 0xd8, 0xda, 0x59, 0x27, 0xd1, 0x6a, 0x54,
       0xed, 0x03, 0x0b, 0x19, 0x7e, 0xbb, 0x6c, 0x02, 0x5d, 0x26, 0xf1, 0x0f,
       0x9d, 0x9b, 0x07, 0xb0, 0xbc, 0xf5, 0xe5, 0x75, 0xbf, 0xaa, 0xd3, 0x38,
       0x25, 0x2e, 0xbc, 0xfb, 0xb0, 0xf8, 0x10, 0xed, 0x9f, 0x4c, 0x47, 0xeb,
       0x8d, 0x8b, 0x82, 0xd6, 0x58, 0x13, 0x84, 0x5d, 0x84, 0xac, 0x4c, 0x6a,
       0xf0, 0x6d, 0xf3, 0x58, 0x68, 0x50, 0x25, 0xea, 0xaf, 0xe5, 0xbf, 0x1a,
       0xbe, 0xa8, 0xc0, 0x63, 0xe1, 0x15, 0xba, 0x5c, 0xd2, 0x58, 0x45, 0xb0,
       0xd2, 0xc2, 0xbd, 0x24, 0x53, 0x49, 0x02, 0x81, 0x81, 0x00, 0xe5, 0x4a,
       0x2e, 0x1e, 0xc1, 0xc5, 0xb8, 0xf0, 0x21, 0x13, 0x05, 0x7e, 0x63, 0x21,
       0x9b, 0xcc, 0xb8, 0x89, 0xf6, 0x21, 0x50, 0xca, 0xdb, 0x8e, 0x26, 0x6c,
       0x9e, 0x64, 0xb3, 0x79, 0xcf, 0x16, 0xe1, 0x6c, 0x75, 0x46, 0xf4, 0x91,
       0xf4, 0x81, 0x28, 0x52, 0x5e, 0x9e, 0x60, 0x9a, 0xcc, 0x02, 0xfa, 0xeb,
       0x5f, 0x1f, 0x92, 0x13, 0xab, 0x13, 0xb5, 0x95, 0xea, 0x14, 0x3d, 0x88,
       0x36, 0x1b, 0x69, 0xaa, 0x18, 0x50, 0xdb, 0xce, 0x93, 0x51, 0x8a, 0xed,
       0x1c, 0x4e, 0x88, 0xaf, 0x0d, 0x36, 0xcd, 0xe5, 0xe6, 0x0f, 0x0f, 0x69,
       0x59, 0xe8, 0xd6, 0x42, 0x4e, 0x5f, 0x17, 0x10, 0x30, 0x24, 0x37, 0x6a,
       0x56, 0x39, 0xda, 0x8a, 0x35, 0x8c, 0x18, 0x9b, 0xac, 0xde, 0x4a, 0xa4,
       0x82, 0xa0, 0x79, 0x2d, 0xab, 0x8c, 0xff, 0x9d, 0x95, 0x1e, 0x97, 0x45,
       0x16, 0xab, 0xdf, 0xe7, 0xe6, 0x45, 0x02, 0x81, 0x81, 0x00, 0xde, 0xba,
       0xe6, 0x5c, 0xe0, 0x35, 0xd6, 0x37, 0x89, 0x7d, 0xbd, 0x65, 0x8f, 0x64,
       0x55, 0xed, 0x1b, 0x0a, 0x71, 0x9e, 0x69, 0xd2, 0xa4, 0xe9, 0x31, 0xf9,
       0x22, 0x66, 0xdb, 0x11, 0x85, 0xc0, 0x16, 0x88, 0x34, 0xde, 0x08, 0x71,
       0x91, 0x1c, 0x69, 0xcf, 0x55, 0x5a, 0xf9, 0x54, 0xdb, 0x55, 0x46, 0xfa,
       0x3a, 0x43, 0x3b, 0xd0, 0xf5, 0x8c, 0x58, 0x80, 0xf2, 0x06, 0x6d, 0x54,
       0x79, 0x73, 0x70, 0x6c, 0x16, 0xbd, 0x3a, 0x7e, 0x30, 0x27, 0xf3, 0x69,
       0x02, 0x32, 0x46, 0xf1, 0xf8, 0x13, 0xeb, 0x73, 0x02, 0x9d, 0xf8, 0x2e,
       0x4e, 0x93, 0x84, 0x92, 0xbe, 0x7b, 0x6d, 0x49, 0x16, 0xf7, 0x7e, 0x16,
       0xfb, 0x04, 0x90, 0x99, 0x42, 0x39, 0x32, 0xdb, 0xe2, 0x42, 0x92, 0x4e,
       0x42, 0xa4, 0x28, 0x70, 0x9b, 0x33, 0xda, 0x4a, 0xef, 0xdc, 0xe4, 0x93,
       0x32, 0x01, 0x1d, 0x02, 0xad, 0x7b, 0x02, 0x81, 0x81, 0x00, 0xdc, 0x2d,
       0xe8, 0xad, 0xe6, 0x5b, 0x8d, 0x25, 0x22, 0x4d, 0x96, 0xc7, 0xf0, 0x3f,
       0xb4, 0xd1, 0xd9, 0x1f, 0xba, 0x37, 0xf1, 0xd2, 0x6b, 0x15, 0x4c, 0xf6,
       0x9e, 0xff, 0x8a, 0x8d, 0x5c, 0xfc, 0xd6, 0xc9, 0x84, 0xb0, 0xf7, 0x68,
       0x35, 0x07, 0xd6, 0x05, 0x8b, 0x10, 0xc1, 0x29, 0xc4, 0xe0, 0xd3, 0xbd,
       0x34, 0x22, 0x27, 0xef, 0x35, 0x27, 0xff, 0x06, 0x8f, 0xba, 0x91, 0xff,
       0xfc, 0x1d, 0x44, 0xd1, 0x6e, 0xfa, 0x2e, 0xa9, 0x67, 0x34, 0x35, 0x99,
       0x4d, 0xc6, 0x68, 0x60, 0xd8, 0xea, 0x98, 0xbb, 0xbc, 0xb9, 0x17, 0x8e,
       0x8e, 0x25, 0x15, 0xa2, 0xa4, 0x89, 0x91, 0xa7, 0x1c, 0xe3, 0x9a, 0x47,
       0x45, 0xb7, 0xd6, 0x91, 0x43, 0xac, 0x5d, 0x71, 0x18, 0x86, 0x79, 0xdd,
       0x12, 0x07, 0x31, 0x76, 0x56, 0xb7, 0x56, 0x3b, 0x27, 0x98, 0x31, 0xa0,
       0xc9, 0x8d, 0x90, 0xbc, 0xaa, 0x95, 0x02, 0x81, 0x80, 0x34, 0xa9, 0x0d,
       0xe4, 0x31, 0xa2, 0xa8, 0xf6, 0x52, 0x8c, 0xa7, 0x26, 0x07, 0x04, 0x1b,
       0x08, 0xc7, 0x56, 0xed, 0xcc, 0x1d, 0x8b, 0x0f, 0x30, 0x8f, 0x7f, 0x2e,
       0xf2, 0x10, 0xa3, 0x90, 0xf2, 0xfc, 0xa0, 0xd1, 0x97, 0x19, 0x79, 0xf8,
       0x6c, 0x36, 0x5c, 0x2d, 0xfb, 0x27, 0x6e, 0x37, 0xb9, 0x6e, 0xe1, 0xa4,
       0xba, 0xd6, 0xbe, 0xad, 0xff, 0xb3, 0xc1, 0x30, 0xf7, 0xf2, 0x0b, 0x81,
       0xf7, 0x98, 0x42, 0x06, 0x12, 0x51, 0x6d, 0x1a, 0x67, 0xa7, 0xb6, 0x51,
       0x2d, 0x9f, 0xf6, 0x7f, 0xc7, 0xfd, 0xe8, 0x20, 0x5b, 0x47, 0x1d, 0x73,
       0xb8, 0x8f, 0x24, 0xbe, 0xe2, 0xa1, 0xd1, 0x21, 0x1b, 0xfc, 0xf4, 0xe3,
       0xfe, 0x8d, 0x4d, 0x9f, 0x09, 0xb5, 0x0b, 0xa5, 0xf0, 0x45, 0x75, 0x39,
       0x6e, 0x64, 0x9d, 0x53, 0x24, 0xac, 0x5d, 0x01, 0x5f, 0x41, 0xaf, 0xc7,
       0xa7, 0xd9, 0xbb, 0x13, 0x57, 0x02, 0x81, 0x80, 0x3b, 0x1c, 0x0d, 0xc4,
       0xc4, 0xd2, 0x6c, 0x3d, 0xd9, 0x75, 0x74, 0x55, 0xb7, 0xfd, 0xec, 0xe3,
       0x3c, 0x8e, 0x62, 0xd3, 0xfe, 0x11, 0x0f, 0x6b, 0x4d, 0x6f, 0x71, 0x37,
       0xa5, 0x2a, 0x8d, 0x16, 0x0b, 0xd1, 0xf3, 0xb5, 0x0b, 0x13, 0x5a, 0x0f,
       0x9d, 0xef, 0x65, 0xf9, 0x6f, 0x9d, 0x4f, 0x80, 0x39, 0x87, 0x84, 0x33,
       0xd2, 0x83, 0xd0, 0xe4, 0xf8, 0xcb, 0xef, 0x3d, 0xe6, 0x12, 0x3c, 0xed,
       0x15, 0xec, 0x3c, 0x74, 0x86, 0x96, 0x63, 0x03, 0x1a, 0x0b, 0xaf, 0xc6,
       0x04, 0x35, 0xe5, 0x26, 0xf0, 0x98, 0xc1, 0x44, 0xb8, 0x5f, 0xda, 0x22,
       0xec, 0x59, 0xac, 0x64, 0xe8, 0x65, 0xfa, 0x3c, 0x9d, 0x3e, 0x7f, 0xcc,
       0x74, 0x28, 0x20, 0xb1, 0xa7, 0x03, 0xa2, 0x2c, 0xf0, 0x19, 0x4b, 0xfe,
       0xa0, 0x4c, 0x8c, 0xb7, 0xbc, 0x22, 0xd9, 0x2f, 0x42, 0xaf, 0xed, 0x87,
       0x73, 0xf4, 0x8a, 0x48
     };
     unsigned int root_priv_der_len = 1192;

     unsigned char root_cert_der[] = {
       0x30, 0x82, 0x04, 0x04, 0x30, 0x82, 0x02, 0xec, 0xa0, 0x03, 0x02, 0x01,
       0x02, 0x02, 0x09, 0x00, 0xee, 0x7a, 0xf8, 0x20, 0x3a, 0xb1, 0x69, 0x80,
       0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01,
       0x0b, 0x05, 0x00, 0x30, 0x81, 0x95, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03,
       0x55, 0x04, 0x06, 0x13, 0x02, 0x43, 0x48, 0x31, 0x12, 0x30, 0x10, 0x06,
       0x03, 0x55, 0x04, 0x08, 0x0c, 0x09, 0x53, 0x74, 0x2e, 0x47, 0x61, 0x6c,
       0x6c, 0x65, 0x6e, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x07,
       0x0c, 0x06, 0x46, 0x6c, 0x61, 0x77, 0x69, 0x6c, 0x31, 0x1e, 0x30, 0x1c,
       0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x15, 0x42, 0x55, 0x43, 0x48, 0x49,
       0x20, 0x4c, 0x61, 0x62, 0x6f, 0x72, 0x74, 0x65, 0x63, 0x68, 0x6e, 0x69,
       0x6b, 0x20, 0x41, 0x47, 0x31, 0x1e, 0x30, 0x1c, 0x06, 0x03, 0x55, 0x04,
       0x03, 0x0c, 0x15, 0x42, 0x75, 0x63, 0x68, 0x69, 0x4f, 0x70, 0x65, 0x6e,
       0x49, 0x6e, 0x74, 0x65, 0x72, 0x66, 0x61, 0x63, 0x65, 0x20, 0x43, 0x41,
       0x31, 0x21, 0x30, 0x1f, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
       0x01, 0x09, 0x01, 0x16, 0x12, 0x73, 0x6f, 0x66, 0x74, 0x77, 0x61, 0x72,
       0x65, 0x40, 0x62, 0x75, 0x63, 0x68, 0x69, 0x2e, 0x63, 0x6f, 0x6d, 0x30,
       0x20, 0x17, 0x0d, 0x31, 0x38, 0x30, 0x37, 0x33, 0x30, 0x31, 0x32, 0x32,
       0x33, 0x34, 0x31, 0x5a, 0x18, 0x0f, 0x32, 0x30, 0x35, 0x38, 0x30, 0x37,
       0x33, 0x30, 0x31, 0x32, 0x32, 0x33, 0x34, 0x31, 0x5a, 0x30, 0x81, 0x95,
       0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x43,
       0x48, 0x31, 0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x09,
       0x53, 0x74, 0x2e, 0x47, 0x61, 0x6c, 0x6c, 0x65, 0x6e, 0x31, 0x0f, 0x30,
       0x0d, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x06, 0x46, 0x6c, 0x61, 0x77,
       0x69, 0x6c, 0x31, 0x1e, 0x30, 0x1c, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c,
       0x15, 0x42, 0x55, 0x43, 0x48, 0x49, 0x20, 0x4c, 0x61, 0x62, 0x6f, 0x72,
       0x74, 0x65, 0x63, 0x68, 0x6e, 0x69, 0x6b, 0x20, 0x41, 0x47, 0x31, 0x1e,
       0x30, 0x1c, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c, 0x15, 0x42, 0x75, 0x63,
       0x68, 0x69, 0x4f, 0x70, 0x65, 0x6e, 0x49, 0x6e, 0x74, 0x65, 0x72, 0x66,
       0x61, 0x63, 0x65, 0x20, 0x43, 0x41, 0x31, 0x21, 0x30, 0x1f, 0x06, 0x09,
       0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x09, 0x01, 0x16, 0x12, 0x73,
       0x6f, 0x66, 0x74, 0x77, 0x61, 0x72, 0x65, 0x40, 0x62, 0x75, 0x63, 0x68,
       0x69, 0x2e, 0x63, 0x6f, 0x6d, 0x30, 0x82, 0x01, 0x22, 0x30, 0x0d, 0x06,
       0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00,
       0x03, 0x82, 0x01, 0x0f, 0x00, 0x30, 0x82, 0x01, 0x0a, 0x02, 0x82, 0x01,
       0x01, 0x00, 0xc7, 0x7d, 0xba, 0x38, 0x03, 0x4b, 0x95, 0xc2, 0x18, 0xea,
       0xca, 0x7a, 0x97, 0xc2, 0x49, 0x66, 0xb5, 0x5e, 0x33, 0x9d, 0x44, 0xe8,
       0x70, 0x5b, 0xa6, 0xfb, 0x47, 0xf3, 0xb2, 0x4b, 0x1c, 0xc5, 0x1f, 0x39,
       0xb7, 0xbb, 0xe5, 0xab, 0x32, 0xe8, 0x9b, 0xce, 0x69, 0x0f, 0x3c, 0xda,
       0xfb, 0x8e, 0x74, 0xa7, 0x84, 0x3e, 0x73, 0x70, 0xb6, 0xf8, 0x45, 0x91,
       0x1d, 0x22, 0x7e, 0x68, 0x6a, 0x57, 0x07, 0x6e, 0x75, 0x99, 0x50, 0x4e,
       0xea, 0x0d, 0x41, 0x78, 0x7d, 0xac, 0x95, 0xfe, 0x9e, 0x0c, 0xa1, 0x37,
       0x4c, 0xd8, 0xdf, 0x94, 0x22, 0x10, 0x09, 0x87, 0x47, 0xb4, 0x9a, 0xad,
       0x73, 0xba, 0x2a, 0xee, 0xd1, 0xe9, 0x43, 0x68, 0x3d, 0x55, 0x48, 0x70,
       0xcc, 0x9f, 0xee, 0xfa, 0xcd, 0x31, 0xb6, 0xe7, 0xd7, 0x66, 0xdf, 0x94,
       0x03, 0xa1, 0x69, 0xb2, 0x6d, 0x9f, 0xdf, 0x0b, 0xac, 0xa3, 0x66, 0x23,
       0xe2, 0xe0, 0x12, 0xb7, 0xbc, 0x25, 0xfc, 0x6b, 0xce, 0x0f, 0x47, 0x43,
       0x92, 0xef, 0xda, 0x4b, 0xe1, 0xec, 0x57, 0x67, 0x67, 0x63, 0xc5, 0x9a,
       0x9c, 0x99, 0x2d, 0x55, 0x96, 0xcf, 0x18, 0xb2, 0x36, 0xea, 0x60, 0xf2,
       0xe8, 0xb9, 0x8d, 0xfa, 0xa4, 0x10, 0x55, 0x1b, 0x23, 0x58, 0xab, 0x09,
       0xf5, 0x96, 0x35, 0xb8, 0x0c, 0x57, 0x42, 0xd8, 0x6c, 0xe7, 0xfe, 0xe0,
       0x1e, 0xdd, 0xed, 0x9f, 0x67, 0xed, 0x19, 0x11, 0x2c, 0xa7, 0x31, 0xf8,
       0xef, 0xda, 0x05, 0x6e, 0x57, 0x6a, 0x56, 0xd5, 0x42, 0x7f, 0xd0, 0x83,
       0xfd, 0x23, 0xeb, 0xb2, 0x30, 0xbc, 0x97, 0x08, 0x12, 0x80, 0x84, 0x5c,
       0x8f, 0x68, 0xbf, 0x49, 0x13, 0xb1, 0x42, 0xd7, 0x8c, 0x0a, 0x22, 0x86,
       0x02, 0xca, 0xff, 0xa9, 0x4d, 0xbf, 0x5a, 0xe1, 0x65, 0xf9, 0xdc, 0xb9,
       0x70, 0x0e, 0xe8, 0x92, 0x44, 0x27, 0x02, 0x03, 0x01, 0x00, 0x01, 0xa3,
       0x53, 0x30, 0x51, 0x30, 0x1d, 0x06, 0x03, 0x55, 0x1d, 0x0e, 0x04, 0x16,
       0x04, 0x14, 0x45, 0x1e, 0xa7, 0x4c, 0x42, 0xe8, 0x37, 0x9e, 0x67, 0x72,
       0x27, 0xa0, 0x1b, 0xae, 0x1c, 0xa0, 0x50, 0x2e, 0xf1, 0x90, 0x30, 0x1f,
       0x06, 0x03, 0x55, 0x1d, 0x23, 0x04, 0x18, 0x30, 0x16, 0x80, 0x14, 0x45,
       0x1e, 0xa7, 0x4c, 0x42, 0xe8, 0x37, 0x9e, 0x67, 0x72, 0x27, 0xa0, 0x1b,
       0xae, 0x1c, 0xa0, 0x50, 0x2e, 0xf1, 0x90, 0x30, 0x0f, 0x06, 0x03, 0x55,
       0x1d, 0x13, 0x01, 0x01, 0xff, 0x04, 0x05, 0x30, 0x03, 0x01, 0x01, 0xff,
       0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01,
       0x0b, 0x05, 0x00, 0x03, 0x82, 0x01, 0x01, 0x00, 0x73, 0x0c, 0x2c, 0x7f,
       0xc9, 0xce, 0x67, 0xfb, 0x7f, 0x23, 0xf1, 0x4e, 0xe0, 0x8e, 0xe9, 0x89,
       0x99, 0xdc, 0x59, 0x95, 0xac, 0xfa, 0x3d, 0xaf, 0x5a, 0x12, 0xa9, 0x6c,
       0x47, 0x6e, 0xc1, 0x3e, 0xcc, 0xb9, 0x76, 0x2e, 0x03, 0xe3, 0x55, 0x8e,
       0x32, 0xc6, 0x75, 0xd7, 0x24, 0x6b, 0xd4, 0x6c, 0x6b, 0x41, 0x20, 0xb1,
       0xfe, 0x38, 0x8e, 0x5d, 0x15, 0x4f, 0x55, 0x77, 0x5f, 0x48, 0x0d, 0xa4,
       0x7e, 0xb5, 0x73, 0x55, 0xac, 0xb0, 0xef, 0xb1, 0xe7, 0x5b, 0x19, 0x98,
       0x17, 0x5c, 0x30, 0xf0, 0xbc, 0x2d, 0xfd, 0xb6, 0x63, 0x94, 0x8e, 0x61,
       0x50, 0xc9, 0xf0, 0xcc, 0x71, 0x13, 0x69, 0xa3, 0x25, 0x94, 0xd2, 0x10,
       0x3f, 0x73, 0x73, 0x4c, 0x67, 0x13, 0xb5, 0x7e, 0x50, 0x96, 0xfc, 0x44,
       0xc5, 0xdb, 0x2e, 0x9b, 0x83, 0x99, 0xf2, 0x0a, 0x48, 0xbe, 0x35, 0x1f,
       0x5b, 0xdc, 0xe9, 0x41, 0xd1, 0xe5, 0xb3, 0x48, 0x79, 0x8b, 0x17, 0xce,
       0x9d, 0x38, 0x0e, 0x29, 0xcf, 0x22, 0xb1, 0x35, 0x45, 0x24, 0x16, 0x82,
       0x34, 0x99, 0x1a, 0x43, 0xbd, 0xbc, 0x7b, 0xdb, 0xee, 0x4b, 0x25, 0xe7,
       0xe8, 0x2e, 0x16, 0x2b, 0x89, 0xc8, 0xc9, 0x5a, 0x3d, 0x50, 0x56, 0xb8,
       0x30, 0x61, 0xc1, 0x8e, 0xaf, 0x6b, 0x2a, 0x3e, 0x42, 0x4d, 0xca, 0x8a,
       0x07, 0x4d, 0xb8, 0xd6, 0x3f, 0x15, 0x4f, 0x8f, 0xed, 0x2f, 0x7c, 0xa6,
       0xc5, 0x09, 0x4b, 0x97, 0x31, 0xba, 0x0b, 0x0d, 0xbc, 0x7b, 0xb5, 0x00,
       0x23, 0x2f, 0x9a, 0x6d, 0xdd, 0xaa, 0xe3, 0x88, 0xde, 0x89, 0x14, 0x33,
       0x3b, 0xcd, 0x27, 0x7c, 0x40, 0x7d, 0xab, 0x09, 0x98, 0xd6, 0x9e, 0x98,
       0x2d, 0xb3, 0x23, 0xe2, 0xff, 0xe3, 0xb5, 0xcc, 0x23, 0xfe, 0x6c, 0xb7,
       0x9e, 0xfe, 0xf3, 0x66, 0x23, 0x21, 0xb5, 0x4c, 0x12, 0x29, 0x8b, 0x54
     };
     unsigned int root_cert_der_len = 1032;

            wc_SetIssuerBuffer(&my_cert, (const byte*)root_cert_der, root_cert_der_len);

            RsaKey issuer_key;
            wc_InitRsaKey(&issuer_key, NULL);
            word32 key_idx = 0; // key offset
            int ret = wc_RsaPrivateKeyDecode(root_priv_der, &key_idx, &issuer_key, root_priv_der_len);
            if (ret != 0)
            {
              ERROR("failed to parse root private key: %d\n", ret);
              return -1;
            }

            // generate
     #if defined(USE_ECC_KEYS) && USE_ECC_KEYS
            RestCertSize = wc_MakeCert(&my_cert, (byte*)RestCert, sizeof(RestCert), NULL, &my_key, &my_rng);
     #else
            RestCertSize = wc_MakeCert(&my_cert, (byte*)RestCert, sizeof(RestCert), &my_key, NULL, &my_rng);
     #endif // USE_ECC_KEYS
            if (RestCertSize <= 0)
            {
               ERROR("failed to generate certificate: %d\n", RestCertSize);
               return -1;
            }

            // and sign it
     #if 0 && defined(USE_ECC_KEYS) && USE_ECC_KEYS // always use RSA because root certificate is hardcoded with RSA key!!!
            RestCertSize = wc_SignCert(my_cert.bodySz, my_cert.sigType, (byte*)RestCert, sizeof(RestCert), NULL, &issuer_key, &my_rng);
     #else
            RestCertSize = wc_SignCert(my_cert.bodySz, my_cert.sigType, (byte*)RestCert, sizeof(RestCert), &issuer_key, NULL, &my_rng);
     #endif // USE_ECC_KEYS
            if (RestCertSize <= 0)
            {
               ERROR("failed to sign certificate: %d\n", RestCertSize);
               return -1;
            }

            wc_FreeRsaKey(&issuer_key);
     #else
            // generate self-signed certificate
     #if defined(USE_ECC_KEYS) && USE_ECC_KEYS
            RestCertSize = wc_MakeCert(&my_cert, (byte*)RestCert, sizeof(RestCert), NULL, &my_key, &my_rng);
     #else
            RestCertSize = wc_MakeCert(&my_cert, (byte*)RestCert, sizeof(RestCert), &my_key, NULL, &my_rng);
     #endif // USE_ECC_KEYS
            if (RestCertSize <= 0)
            {
               LOG1(BSL::Logger::lmError, "failed to generate certificate: %d\n", RestCertSize);
               return false;
            }

            // and sign it
     #if defined(USE_ECC_KEYS) && USE_ECC_KEYS
            RestCertSize = wc_SignCert(my_cert.bodySz, my_cert.sigType, (byte*)RestCert, sizeof(RestCert), NULL, &my_key, &my_rng);
     #else
            RestCertSize = wc_SignCert(my_cert.bodySz, my_cert.sigType, (byte*)RestCert, sizeof(RestCert), &my_key, NULL, &my_rng);
     #endif // USE_ECC_KEYS
            if (RestCertSize <= 0)
            {
               LOG1(BSL::Logger::lmError, "failed to sign certificate: %d\n", RestCertSize);
               return false;
            }
     #endif

            INFO("New REST service certificate of %d bytes generated", RestCertSize);
            RestCertUnsaved = 1; // need to write it back to EEPROM
        }

     #if defined(USE_ECC_KEYS) && USE_ECC_KEYS
        wc_ecc_free(&my_key);
     #else
        wc_FreeRsaKey(&my_key);
     #endif // USE_ECC_KEYS

        FILE *f = fopen("cert.der", "w");
        fwrite(RestCert, 1, RestCertSize, f);
        fclose(f);

        f = fopen("key.der", "w");
        fwrite(RestKey, 1, RestKeySize, f);
        fclose(f);
    }

    if (all)
    {
        test_parse_query("hello=world&test=1&foo&=&foo=&=bar x#frag", "hello", "world");
        test_parse_query("hello=world&test=1&foo&=&foo=&=bar x#frag", "test", "1");
        test_parse_query("hello=world&test=1&foo&=&foo=&=bar x#frag", "bad", 0);
    }

    if (all)
    {
        // port auto-detection
        test_parse_url("https://my.server.com/hello", "https", "my.server.com", "/hello", 443);
        test_parse_url("http://my.server.com/hello", "http", "my.server.com", "/hello", 80);
        test_parse_url("wss://my.server.com/hello", "wss", "my.server.com", "/hello", 443);
        test_parse_url("ws://my.server.com/hello", "ws", "my.server.com", "/hello", 80);
        test_parse_url("ftp://my.server.com/hello", "ftp", "my.server.com", "/hello", 21);
        test_parse_url("telnet://my.server.com/hello", "telnet", "my.server.com", "/hello", 0);

        // custom port
        test_parse_url("https://my.server.com:8080/hello", "https", "my.server.com", "/hello", 8080);
        test_parse_url("http://my.server.com:8080/hello", "http", "my.server.com", "/hello", 8080);
        test_parse_url("https://my.server.com:8080/hello?foo=bar", "https", "my.server.com", "/hello?foo=bar", 8080);
        test_parse_url("https://my.server.com:8080/hello?foo=bar#data", "https", "my.server.com", "/hello?foo=bar#data", 8080);
        test_parse_url("https://my.server.com:8080/hello#data", "https", "my.server.com", "/hello#data", 8080);

        // default values
        test_parse_url("my.server.com:8080/hello", "https", "my.server.com", "/hello", 8080);
        test_parse_url("https://:8080/hello", "https", "", "/hello", 8080);
        test_parse_url("https://my.server.com:/hello", "https", "my.server.com", "/hello", 0);
        test_parse_url("https://my.server.com/", "https", "my.server.com", "/", 443);
        test_parse_url("https://my.server.com", "https", "my.server.com", "", 443);
        test_parse_url("", "https", "", "", 443);
    }

    if (all)
    {
        test_match_uri("/version", "/version", 1);
        test_match_uri("/version/*", "/version/1", 1);
        test_match_uri("/version/*", "/version/2#hello", 1);
        test_match_uri("/version/*", "/version/2?hello=1", 1);
        test_match_uri("/user/*/add", "/user/John/add", 1);
        test_match_uri("/user/*/add", "/user/Mery/del", 0);
        test_match_uri("/user/*", "/user/Mery/del?hello=no", 1);
    }

    if (all)
    {
        test_find_crlf("no", -1, 0);
        test_find_crlf("no\nno", -1, 0);
        test_find_crlf("\nno\nno", -1, 0);
        test_find_crlf("no\nno\rx\nno", -1, 0);
        test_find_crlf("\n\n\r\nyes", -1, "\r\nyes");
        test_find_crlf("no\r\nyes", -1, "\r\nyes");
        test_find_crlf("\r\nyes", -1, "\r\nyes");
        test_find_crlf("no\nno\r\nyes", -1, "\r\nyes");
        test_find_crlf("\nno\r\nyes", -1, "\r\nyes");
        test_find_crlf("\nno\r\nyes", 4, 0);
    }
}
